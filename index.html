<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <link rel="icon" type="image/svg+xml" href="/vite.svg" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CAN Tracer</title>
  <style>
    :root {
      --bg-color: #1e1e1e;
      --text-color: #d4d4d4;
      --accent-color: #007acc;
      --border-color: #3e3e42;
      --log-header-bg: #252526;
      --log-row-odd: #1e1e1e;
      --log-row-even: #252526;
      --log-row-hover: #2a2d2e;
      --font-family: 'Consolas', 'Courier New', monospace;
    }

    * { box-sizing: border-box; }
    
    body {
      margin: 0;
      padding: 0;
      background-color: var(--bg-color);
      color: var(--text-color);
      font-family: var(--font-family);
      height: 100vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    /* Top Bar: Connection & Basic Controls */
    #top-bar {
      height: 40px;
      display: flex;
      align-items: center;
      padding: 0 10px;
      border-bottom: 1px solid var(--border-color);
      background-color: var(--log-header-bg);
      gap: 10px;
    }

    button {
      background-color: #3c3c3c;
      border: 1px solid var(--border-color);
      color: var(--text-color);
      padding: 5px 10px;
      cursor: pointer;
      font-size: 13px;
    }
    
    button:hover { background-color: #4e4e4e; }
    button:active { background-color: #007acc; }
    button:disabled { opacity: 0.5; cursor: not-allowed; }

    select, input {
      background-color: #252526;
      border: 1px solid var(--border-color);
      color: var(--text-color);
      padding: 4px;
    }

    /* Main Area: Split View */
    #main-area {
      flex: 1;
      display: flex;
      overflow: hidden;
    }

    /* Left Panel: Settings & Transmit */
    #sidebar {
      width: 300px;
      border-right: 1px solid var(--border-color);
      display: flex;
      flex-direction: column;
      padding: 10px;
      gap: 15px;
      overflow-y: auto;
      background-color: #2d2d30;
    }

    .panel-section {
      border: 1px solid var(--border-color);
      padding: 10px;
      border-radius: 4px;
    }

    .panel-title {
      font-weight: bold;
      margin-bottom: 10px;
      border-bottom: 1px solid var(--border-color);
      padding-bottom: 5px;
      font-size: 14px;
    }

    .control-row {
      display: flex;
      align-items: center;
      margin-bottom: 8px;
      justify-content: space-between;
      gap: 5px;
    }

    .control-row label { font-size: 12px; }
    .control-row input[type="checkbox"] { width: auto; }

    /* Log View: Virtual Scroll Area */
    #log-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      position: relative;
      background-color: var(--bg-color);
    }

    #log-header {
      display: grid;
      grid-template-columns: 80px 80px 60px 40px 1fr;
      padding: 5px 10px;
      background-color: var(--log-header-bg);
      border-bottom: 1px solid var(--border-color);
      font-weight: bold;
      font-size: 13px;
    }

    #log-list-viewport {
      flex: 1;
      overflow-y: auto;
      position: relative;
    }

    #log-list-content {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      /* height will be set dynamically via JS */
    }

    .log-row {
      display: grid;
      grid-template-columns: 80px 80px 60px 40px 1fr;
      padding: 2px 10px;
      font-size: 12px;
      border-bottom: 1px solid #2d2d2d;
      height: 24px; /* Fixed height is key for virtual scroll */
      line-height: 20px;
      position: absolute; /* positioned absolutely within the content div */
      width: 100%;
      box-sizing: border-box;
      white-space: nowrap;
    }

    .log-row:nth-child(even) { background-color: var(--log-row-even); }
    .log-row:hover { background-color: var(--log-row-hover); }

    .col-data { font-family: monospace; }
    .type-tx { color: #ce9178; } /* Red-ish for TX */
    .type-rx { color: #9cdcfe; } /* Blue-ish for RX */
    .type-err { color: #f44747; }

    /* Footer: Status Bar */
    #status-bar {
      height: 24px;
      background-color: #007acc;
      color: white;
      display: flex;
      align-items: center;
      padding: 0 10px;
      font-size: 12px;
      gap: 20px;
    }

  </style>
</head>
<body>

  <!-- Top Bar -->
  <div id="top-bar">
    <button id="btn-connect">Connect</button>
    <button id="btn-disconnect" disabled>Disconnect</button>
    <span style="flex:1"></span>
    <button id="btn-clear">Clear Log</button>
    <button id="btn-save">Save Trace</button>
    <button id="btn-load">Load Trace</button>
    <input type="file" id="file-input" style="display:none" accept=".txt,.csv,.log">
  </div>

  <!-- Main Area -->
  <div id="main-area">
    
    <!-- Sidebar -->
    <div id="sidebar">
      
      <!-- Connection Settings -->
      <div class="panel-section">
        <div class="panel-title">Settings</div>
        <div class="control-row">
          <label>CAN Bitrate:</label>
          <select id="slcan-baud">
            <option value="S0">10 kbit/s</option>
            <option value="S1">20 kbit/s</option>
            <option value="S2">50 kbit/s</option>
            <option value="S3">100 kbit/s</option>
            <option value="S4" selected>125 kbit/s</option>
            <option value="S5">250 kbit/s</option>
            <option value="S6">500 kbit/s</option>
            <option value="S7">800 kbit/s</option>
            <option value="S8">1 Mbit/s</option>
            <option value="S9">83.3 kbit/s</option>
            <option value="SA">75 kbit/s</option>
            <option value="SB">62.5 kbit/s</option>
            <option value="SC">33.3 kbit/s</option>
            <option value="SD">5 kbit/s</option>
          </select>
        </div>
        <div class="control-row">
          <label>FD Bitrate:</label>
          <select id="slcan-baud-fd">
            <option value="Y1">1 Mbit/s</option>
            <option value="Y2" selected>2 Mbit/s</option>
            <option value="Y3">3 Mbit/s</option>
            <option value="Y4">4 Mbit/s</option>
            <option value="Y5">5 Mbit/s</option>
          </select>
        </div>
        <div class="control-row">
          <label>Mode:</label>
          <select id="slcan-mode">
            <option value="M0">Normal</option>
            <option value="M1">Listen Only</option>
          </select>
        </div>
        <div class="control-row">
           <label>Open Channel:</label>
           <input type="checkbox" id="chk-open" disabled>
        </div>
      </div>

      <!-- Transmit -->
      <div class="panel-section">
        <div class="panel-title">Transmit (TX)</div>
        <div class="control-row">
          <label>Type:</label>
          <select id="tx-type" style="width: 100px;">
            <option value="std">Classic CAN</option>
            <option value="fd">CAN FD</option>
            <option value="fd_brs">CAN FD + BRS</option>
            <option value="rtr">Remote (RTR)</option>
          </select>
        </div>
        <div class="control-row">
          <label>ID (Hex):</label>
          <input type="text" id="tx-id" value="123" style="width: 60px;">
        </div>
        <div class="control-row">
          <label>Ext ID:</label>
          <input type="checkbox" id="tx-ext">
        </div>
        <div class="control-row">
          <label>Data (Hex):</label>
          <input type="text" id="tx-data" value="11 22 33" placeholder="AA BB ...">
        </div>
        <div class="control-row">
          <button id="btn-send" style="width:100%">Send</button>
        </div>
        <div class="control-row" style="border-top: 1px solid #444; padding-top:5px; margin-top:5px;">
          <label>Auto Send:</label>
          <input type="checkbox" id="chk-auto">
        </div>
        <div class="control-row">
          <label>Interval (ms):</label>
          <input type="number" id="tx-interval" value="1000" style="width: 60px;">
        </div>
      </div>

       <!-- Playback -->
       <div class="panel-section">
        <div class="panel-title">Playback</div>
        <div class="control-row">
            <button id="btn-play-trace" disabled>Play Loaded Trace</button>
        </div>
        <div class="control-row">
            <label>Loop:</label>
            <input type="checkbox" id="chk-loop-trace">
        </div>
      </div>

    </div>

    <!-- Log View -->
    <div id="log-container">
      <div id="log-header">
        <div>Time</div>
        <div>Delta</div>
        <div>ID</div>
        <div>DLC</div>
        <div>Data</div>
      </div>
      <div id="log-list-viewport">
        <div id="log-list-content">
          <!-- Rows will be injected here via JS -->
        </div>
      </div>
    </div>
  
  </div>

  <!-- Status Bar -->
  <div id="status-bar">
    <span id="status-conn">Disconnected</span>
    <span>|</span>
    <span id="status-rx">Rx: 0</span>
    <span>|</span>
    <span id="status-tx">Tx: 0</span>
    <span>|</span>
    <span id="status-fps">Buffer: 0</span>
  </div>

  <script type="module" src="/main.js"></script>
</body>
</html>
