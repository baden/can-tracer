(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const e of document.querySelectorAll('link[rel="modulepreload"]'))s(e);new MutationObserver(e=>{for(const n of e)if(n.type==="childList")for(const o of n.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&s(o)}).observe(document,{childList:!0,subtree:!0});function r(e){const n={};return e.integrity&&(n.integrity=e.integrity),e.referrerPolicy&&(n.referrerPolicy=e.referrerPolicy),e.crossOrigin==="use-credentials"?n.credentials="include":e.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function s(e){if(e.ep)return;e.ep=!0;const n=r(e);fetch(e.href,n)}})();class U{constructor(){this.port=null,this.reader=null,this.writer=null,this.isConnected=!1,this.onData=null}async connect(){if(!navigator.serial)throw new Error("Web Serial API not supported in this browser.");try{return this.port=await navigator.serial.requestPort(),await this.port.open({baudRate:115200,bufferSize:8192,flowControl:"none"}),this.isConnected=!0,!0}catch(t){return console.error("Connection failed:",t),!1}}startReading(){this.isConnected&&!this.reader&&this.readLoop()}async disconnect(){this.reader&&(await this.reader.cancel(),this.reader=null),this.writer&&(this.writer.releaseLock(),this.writer=null),this.port&&(await this.port.close(),this.port=null),this.isConnected=!1}async readLoop(){for(;this.isConnected;){if(!this.port||!this.port.readable){await new Promise(t=>setTimeout(t,100));continue}try{for(this.reader=this.port.readable.getReader();;){const{value:t,done:r}=await this.reader.read();if(r)break;if(t&&this.onData){const s=new TextDecoder().decode(t);this.onData(s)}}}catch(t){console.error("Read error (retrying in 1s):",t),await new Promise(r=>setTimeout(r,1e3))}finally{this.reader&&(this.reader.releaseLock(),this.reader=null)}}}async write(t){if(!this.port||!this.port.writable)return;console.log("Write to serial:",[t]);const r=this.port.writable.getWriter(),s=new TextEncoder;await r.write(s.encode(t)),r.releaseLock()}}class F{constructor(){this.buffer=""}parse(t){this.buffer+=t;const r=[];let s;for(;(s=this.buffer.indexOf("\r"))>=0;){const e=this.buffer.substring(0,s);if(this.buffer=this.buffer.substring(s+1),e.length>0){const n=this.parseLine(e);n&&r.push(n)}}return r}parseLine(t){const r=t.charAt(0);if(r==="t"){const s=parseInt(t.substring(1,4),16),e=parseInt(t.charAt(4),16),n=t.substring(5),o=this.hexStringToBytes(n);return{type:"RX",id:s,ext:!1,dlc:e,data:o,raw:t}}if(r==="T"){const s=parseInt(t.substring(1,9),16),e=parseInt(t.charAt(9),16),n=t.substring(10),o=this.hexStringToBytes(n);return{type:"RX",id:s,ext:!0,dlc:e,data:o,raw:t}}if(r==="r"){const s=parseInt(t.substring(1,4),16),e=parseInt(t.charAt(4),16);return{type:"RTR",id:s,ext:!1,dlc:e,data:[],raw:t}}if(r==="R"){const s=parseInt(t.substring(1,9),16),e=parseInt(t.charAt(9),16);return{type:"RTR",id:s,ext:!0,dlc:e,data:[],raw:t}}if(r==="d"){const s=parseInt(t.substring(1,4),16);t.charAt(4);const e=t.substring(5),n=this.hexStringToBytes(e);return{type:"RX_FD",id:s,ext:!1,dlc:n.length,brs:!1,data:n,raw:t}}if(r==="D"){const s=parseInt(t.substring(1,9),16),e=t.substring(10),n=this.hexStringToBytes(e);return{type:"RX_FD",id:s,ext:!0,dlc:n.length,brs:!1,data:n,raw:t}}if(r==="b"){const s=parseInt(t.substring(1,4),16),e=t.substring(5),n=this.hexStringToBytes(e);return{type:"RX_FD",id:s,ext:!1,dlc:n.length,brs:!0,data:n,raw:t}}if(r==="B"){const s=parseInt(t.substring(1,9),16),e=t.substring(10),n=this.hexStringToBytes(e);return{type:"RX_FD",id:s,ext:!0,dlc:n.length,brs:!0,data:n,raw:t}}return r==="z"||r==="Z"?{type:"CMD_OK",raw:t}:r==="\x07"?{type:"ERROR",raw:t}:{type:"UNKNOWN",raw:t}}hexStringToBytes(t){const r=[];for(let s=0;s<t.length;s+=2)r.push(parseInt(t.substr(s,2),16));return r}cmdSetup(t){return`S${t}\r`}cmdSetupFD(t){return`Y${t}\r`}cmdSetMode(t){return`M${t}\r`}cmdOpen(){return"O\r"}cmdClose(){return"C\r"}lenToDlcChar(t){return t<=8?t.toString(16).toUpperCase():t<=12?"9":t<=16?"A":t<=20?"B":t<=24?"C":t<=32?"D":t<=48?"E":"F"}dlcCharToLen(t){const r=parseInt(t,16);if(r<=8)return r;switch(t.toUpperCase()){case"9":return 12;case"A":return 16;case"B":return 20;case"C":return 24;case"D":return 32;case"E":return 48;case"F":return 64;default:return 0}}cmdTxStd(t,r){const s=t.toString(16).padStart(3,"0").toUpperCase(),e=Math.min(r.length,8),n=e.toString(16).toUpperCase(),o=r.slice(0,e).map(c=>c.toString(16).padStart(2,"0").toUpperCase()).join("");return`t${s}${n}${o}\r`}cmdTxExt(t,r){const s=t.toString(16).padStart(8,"0").toUpperCase(),e=Math.min(r.length,8),n=e.toString(16).toUpperCase(),o=r.slice(0,e).map(c=>c.toString(16).padStart(2,"0").toUpperCase()).join("");return`T${s}${n}${o}\r`}cmdTxRtrStd(t,r){const s=t.toString(16).padStart(3,"0").toUpperCase(),e=Math.min(r,8).toString(16).toUpperCase();return`r${s}${e}\r`}cmdTxRtrExt(t,r){const s=t.toString(16).padStart(8,"0").toUpperCase(),e=Math.min(r,8).toString(16).toUpperCase();return`R${s}${e}\r`}cmdTxFdStd(t,r){const s=t.toString(16).padStart(3,"0").toUpperCase(),e=Math.min(r.length,64),n=this.lenToDlcChar(e),o=r.slice(0,e).map(c=>c.toString(16).padStart(2,"0").toUpperCase()).join("");return`d${s}${n}${o}\r`}cmdTxFdExt(t,r){const s=t.toString(16).padStart(8,"0").toUpperCase(),e=Math.min(r.length,64),n=this.lenToDlcChar(e),o=r.slice(0,e).map(c=>c.toString(16).padStart(2,"0").toUpperCase()).join("");return`D${s}${n}${o}\r`}cmdTxFdBrsStd(t,r){const s=t.toString(16).padStart(3,"0").toUpperCase(),e=Math.min(r.length,64),n=this.lenToDlcChar(e),o=r.slice(0,e).map(c=>c.toString(16).padStart(2,"0").toUpperCase()).join("");return`b${s}${n}${o}\r`}cmdTxFdBrsExt(t,r){const s=t.toString(16).padStart(8,"0").toUpperCase(),e=Math.min(r.length,64),n=this.lenToDlcChar(e),o=r.slice(0,e).map(c=>c.toString(16).padStart(2,"0").toUpperCase()).join("");return`B${s}${n}${o}\r`}}class O{constructor(){this.buffer=[],this.maxSize=1e6,this.listeners=[],this.startTime=Date.now()}add(t){this.buffer.length>=this.maxSize&&this.buffer.shift(),this.buffer.push(t),this.notify()}clear(){this.buffer=[],this.notify()}get length(){return this.buffer.length}get(t){return this.buffer[t]}getAll(){return this.buffer}subscribe(t){this.listeners.push(t)}notify(){}}const h=new O;class M{constructor(){this.logContainer=document.getElementById("log-list-viewport"),this.logContent=document.getElementById("log-list-content"),this.rowHeight=24,this.visibleRows=0,this.scrollTop=0,this.logContainer.addEventListener("scroll",()=>{this.scrollTop=this.logContainer.scrollTop,this.render()}),this.autoScroll=!0,this.logContainer.addEventListener("scroll",()=>{const t=this.logContainer.scrollHeight-this.logContainer.clientHeight;this.logContainer.scrollTop<t-50?this.autoScroll=!1:this.autoScroll=!0}),this.updateDimensions(),window.addEventListener("resize",()=>this.updateDimensions()),this.elRx=document.getElementById("status-rx"),this.elTx=document.getElementById("status-tx"),this.elBuffer=document.getElementById("status-fps"),requestAnimationFrame(()=>this.loop())}updateDimensions(){this.visibleRows=Math.ceil(this.logContainer.clientHeight/this.rowHeight)+5}loop(){const t=h.length;this.elRx.textContent=`Buffer: ${t}`,this.autoScroll&&(this.logContainer.scrollTop=this.logContainer.scrollHeight),this.render(),requestAnimationFrame(()=>this.loop())}render(){const t=h.length,r=t*this.rowHeight;this.logContent.style.height=`${r}px`;const s=this.logContainer.scrollTop,e=Math.floor(s/this.rowHeight),n=Math.min(t,e+this.visibleRows+5);let o="";for(let c=e;c<n;c++){const i=h.get(c);if(!i)continue;const m=typeof i.timestamp=="number"?new Date(i.timestamp).toLocaleTimeString()+"."+(i.timestamp%1e3).toString().padStart(3,"0"):i.timestamp,p=c*this.rowHeight,S=i.type.startsWith("TX")?"type-tx":i.type.startsWith("RX")?"type-rx":"type-err";let w="";i.type.includes("RTR")?w="[RTR]":w=i.data.map(x=>x.toString(16).padStart(2,"0").toUpperCase()).join(" ");let u="";i.ext&&(u+="E"),i.type.includes("FD")&&(u+="F"),i.brs&&(u+="B"),u&&(u=`<span style="color:#888; font-size:10px; margin-left: 2px;">${u}</span>`),o+=`
                <div class="log-row ${S}" style="transform: translateY(${p}px);">
                    <div>${m}</div>
                    <div>${i.delta.toFixed(4)}</div>
                    <div style="display:flex; align-items:center;">${i.id.toString(16).toUpperCase().padStart(3,"0")} ${u}</div>
                    <div>${i.dlc}</div>
                    <div class="col-data">${w}</div>
                </div>
            `}this.logContent.innerHTML=o}}function A(a){const t=a.map(n=>{const o=n.id.toString(16).toUpperCase(),c=n.dlc,i=n.data.map(p=>p.toString(16).padStart(2,"0").toUpperCase()).join(""),m=n.ext?"T":"t";return`${n.timestamp},${n.delta.toFixed(6)},${m},${o},${c},${i}`}).join(`
`),r=new Blob([t],{type:"text/csv"}),s=URL.createObjectURL(r),e=document.createElement("a");e.href=s,e.download=`can_trace_${new Date().toISOString().replace(/[:.]/g,"-")}.csv`,document.body.appendChild(e),e.click(),document.body.removeChild(e),URL.revokeObjectURL(s)}function P(a,t){const r=new FileReader;r.onload=s=>{const n=s.target.result.split(`
`),o=[];n.forEach(c=>{if(!c.trim())return;const i=c.split(",");if(i.length<6)return;const p=i[2]==="T",S=parseInt(i[3],16),w=parseInt(i[4]),u=i[5],x=[];for(let v=0;v<u.length;v+=2)x.push(parseInt(u.substr(v,2),16));o.push({timestamp:i[0],delta:parseFloat(i[1]),type:"RX",id:S,ext:p,dlc:w,data:x})}),t(o)},r.readAsText(a)}const l=new U,d=new F;new M;let b=null,T=Date.now();l.onData=a=>{d.parse(a).forEach(r=>{const s=Date.now(),e=(s-T)/1e3;T=s,h.add({...r,timestamp:s,delta:e})})};const B=document.getElementById("btn-connect"),$=document.getElementById("btn-disconnect"),X=document.getElementById("btn-send"),f=document.getElementById("chk-open"),R=document.getElementById("chk-auto"),L=document.getElementById("slcan-baud"),H=document.getElementById("slcan-baud-fd"),j=document.getElementById("slcan-mode");function k(a){B.disabled=a,$.disabled=!a,document.getElementById("status-conn").textContent=a?"Connected":"Disconnected",f.disabled=!a,a||(f.checked=!1,R.checked=!1,clearInterval(b),b=null)}const E=a=>new Promise(t=>setTimeout(t,a));B.addEventListener("click",async()=>{try{if(await l.connect()){k(!0),await l.write(d.cmdClose()),await E(100);const t=L.value.replace("S","");await l.write(d.cmdSetup(t)),await E(50),await l.write(d.cmdOpen()),f.checked=!0,await E(50),l.startReading()}}catch(a){console.error(a),alert("Connection failed: "+a.message)}});$.addEventListener("click",async()=>{await l.disconnect(),k(!1)});f.addEventListener("change",async a=>{l.isConnected&&(a.target.checked?await l.write(d.cmdOpen()):await l.write(d.cmdClose()))});async function I(a){if(!l.isConnected)return;const t=f.checked;t&&(await l.write(d.cmdClose()),f.checked=!1),await l.write(a),t&&(await l.write(d.cmdOpen()),f.checked=!0)}L.addEventListener("change",a=>I(d.cmdSetup(a.target.value.replace("S",""))));H.addEventListener("change",a=>I(d.cmdSetupFD(a.target.value.replace("Y",""))));j.addEventListener("change",a=>I(d.cmdSetMode(a.target.value.replace("M",""))));async function D(){var o;const a=document.getElementById("tx-id").value,t=document.getElementById("tx-ext").checked,r=document.getElementById("tx-data").value,s=document.getElementById("tx-type").value,e=parseInt(a,16);if(isNaN(e))return;const n=((o=r.match(/[0-9A-Fa-f]{1,2}/g))==null?void 0:o.map(c=>parseInt(c,16)))||[];if(l.isConnected){let c="",i="TX",m=!1;switch(s){case"std":c=t?d.cmdTxExt(e,n):d.cmdTxStd(e,n);break;case"rtr":c=t?d.cmdTxRtrExt(e,n.length):d.cmdTxRtrStd(e,n.length),i="TX_RTR";break;case"fd":c=t?d.cmdTxFdExt(e,n):d.cmdTxFdStd(e,n),i="TX_FD";break;case"fd_brs":c=t?d.cmdTxFdBrsExt(e,n):d.cmdTxFdBrsStd(e,n),i="TX_FD",m=!0;break}await l.write(c);const p=Date.now(),S=(p-T)/1e3;T=p,h.add({type:i,id:e,ext:t,dlc:n.length,data:n,brs:m,timestamp:p,delta:S})}}X.addEventListener("click",D);R.addEventListener("change",a=>{if(a.target.checked){const t=parseInt(document.getElementById("tx-interval").value)||1e3;b=setInterval(D,t)}else clearInterval(b),b=null});document.getElementById("btn-clear").addEventListener("click",()=>{h.clear()});document.getElementById("btn-save").addEventListener("click",()=>{A(h.getAll())});const y=document.getElementById("btn-play-trace"),_=document.getElementById("chk-loop-trace");let g=null,C=[];document.getElementById("btn-load").addEventListener("click",()=>{document.getElementById("file-input").click()});document.getElementById("file-input").addEventListener("change",a=>{const t=a.target.files[0];t&&P(t,r=>{C=r,y.disabled=!1,y.textContent=`Play (${r.length} frames)`,alert(`Loaded ${r.length} packets. Ready to play.`)})});y.addEventListener("click",()=>{if(g){clearInterval(g),g=null,y.textContent="Play Loaded Trace";return}if(C.length===0)return;let a=0;y.textContent="Stop Playback";const t=parseInt(document.getElementById("tx-interval").value)||100;g=setInterval(async()=>{if(a>=C.length)if(_.checked)a=0;else{clearInterval(g),g=null,y.textContent="Play Loaded Trace";return}const r=C[a];if(l.isConnected){const s=r.ext?d.cmdTxExt(r.id,r.data):d.cmdTxStd(r.id,r.data);await l.write(s);const e=Date.now();h.add({...r,type:"TX",timestamp:e,delta:0})}a++},t)});
